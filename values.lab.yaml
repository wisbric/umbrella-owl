# =============================================================================
# umbrella-owl — Lab environment overrides
# =============================================================================
# Layered on top of values.yaml:
#   helm install owl . -f values.lab.yaml -f values.lab-secrets.yaml
#
# This file contains structural configuration only (hostnames, replicas,
# resources, ingress rules, inter-service URLs). All secrets are left empty
# and must be provided via values.lab-secrets.yaml (generated by
# deploy/apply-secrets.sh).
# =============================================================================

# -----------------------------------------------------------------------------
# GHCR registry credentials — pull private container images and Helm charts
# -----------------------------------------------------------------------------
registryCredentials:
  create: true
  username: ""    # Set via values.lab-secrets.yaml
  password: ""    # Set via values.lab-secrets.yaml

# -----------------------------------------------------------------------------
# NightOwl
# -----------------------------------------------------------------------------
nightowl:
  replicaCount:
    api: 1
    worker: 1

  image:
    tag: main

  frontend:
    enabled: true
    image:
      tag: main
    replicas: 1
    resources:
      requests:
        cpu: 25m
        memory: 32Mi
      limits:
        cpu: 100m
        memory: 64Mi

  api:
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 250m
        memory: 128Mi

  worker:
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 125m
        memory: 128Mi

  config:
    logLevel: debug
    corsAllowedOrigins: "https://nightowl.devops.lab"

  secrets:
    databaseUrl: ""       # Set via values.lab-secrets.yaml
    redisUrl: "redis://owl-redis-master:6379/0"
    oidcIssuerUrl: "https://keycloak.devops.lab/realms/owls"
    oidcClientId: "nightowl"
    oidcClientSecret: ""  # Set via values.lab-secrets.yaml
    sessionSecret: ""     # Set via values.lab-secrets.yaml

  ingress:
    enabled: true
    className: nginx
    annotations:
      certmanager.step.sm/cluster-issuer: step-cluster-issuer
    hosts:
      - host: nightowl.devops.lab
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: nightowl-tls
        hosts:
          - nightowl.devops.lab

  serviceMonitor:
    enabled: false

  podDisruptionBudget:
    enabled: false

# -----------------------------------------------------------------------------
# BookOwl
# -----------------------------------------------------------------------------
bookowl:
  image:
    tag: main

  web:
    image:
      tag: main
    replicas: 1
    resources:
      requests:
        cpu: 25m
        memory: 32Mi
      limits:
        cpu: 100m
        memory: 64Mi

  api:
    replicas: 1
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 250m
        memory: 128Mi

  collab:
    replicas: 1
    image:
      tag: main
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 250m
        memory: 128Mi
    wsUrl: "wss://collab.bookowl.devops.lab"
    ingress:
      enabled: true
      host: collab.bookowl.devops.lab

  secretKey: ""  # Set via values.lab-secrets.yaml

  database:
    url: ""  # Set via values.lab-secrets.yaml

  redis:
    url: "redis://owl-redis-master:6379/1"
    host: owl-redis-master
    port: "6379"

  oidc:
    issuerUrl: "https://keycloak.devops.lab/realms/owls"
    clientId: bookowl

  nightowl:
    apiUrl: "http://owl-nightowl:80"
    apiKey: ""  # Set via values.lab-secrets.yaml

  ingress:
    enabled: true
    className: nginx
    annotations:
      certmanager.step.sm/cluster-issuer: step-cluster-issuer
      nginx.ingress.kubernetes.io/proxy-body-size: "20m"
    hosts:
      - host: bookowl.devops.lab
        paths:
          - path: /api
            pathType: Prefix
            service: api
          - path: /auth
            pathType: Prefix
            service: api
          - path: /status
            pathType: Prefix
            service: api
          - path: /
            pathType: Prefix
            service: web
    tls:
      - secretName: bookowl-tls
        hosts:
          - bookowl.devops.lab

  metrics:
    enabled: false
    serviceMonitor:
      enabled: false

  pdb:
    enabled: false

# -----------------------------------------------------------------------------
# TicketOwl
# -----------------------------------------------------------------------------
ticketowl:
  image:
    tag: main

  api:
    replicaCount: 1
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 250m
        memory: 128Mi
    autoscaling:
      enabled: false

  worker:
    replicaCount: 1
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 125m
        memory: 128Mi

  config:
    logLevel: debug
    nightowlApiUrl: "http://owl-nightowl:80"
    bookowlApiUrl: "http://owl-bookowl-api:8081"

  secrets:
    dbUrl: ""             # Set via values.lab-secrets.yaml
    redisUrl: "redis://owl-redis-master:6379/2"
    oidcIssuer: "https://keycloak.devops.lab/realms/owls"
    oidcClientId: "ticketowl"
    encryptionKey: ""     # Set via values.lab-secrets.yaml
    nightowlApiKey: ""    # Set via values.lab-secrets.yaml
    bookowlApiKey: ""     # Set via values.lab-secrets.yaml

  ingress:
    enabled: true
    className: nginx
    annotations:
      certmanager.step.sm/cluster-issuer: step-cluster-issuer
    hosts:
      - host: ticketowl.devops.lab
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: ticketowl-tls
        hosts:
          - ticketowl.devops.lab

  podDisruptionBudget:
    enabled: false

# -----------------------------------------------------------------------------
# PostgreSQL — in-cluster for lab
# -----------------------------------------------------------------------------
postgresql:
  enabled: true
  auth:
    postgresPassword: ""  # Set via values.lab-secrets.yaml
    database: nightowl
  primary:
    persistence:
      size: 10Gi
      # Uses default StorageClass (Longhorn)
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi
    # NOTE: initdb.scripts is in values.lab-secrets.yaml because it contains
    # database user passwords that must match the service database URLs.

# -----------------------------------------------------------------------------
# Redis — in-cluster, standalone, no auth
# -----------------------------------------------------------------------------
redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: false
  master:
    persistence:
      size: 2Gi
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 125m
        memory: 128Mi

# -----------------------------------------------------------------------------
# Keycloak — enabled for OIDC
# -----------------------------------------------------------------------------
keycloak:
  enabled: true
  auth:
    adminUser: admin
    adminPassword: ""  # Set via values.lab-secrets.yaml
  production: false
  proxyHeaders: xforwarded
  postgresql:
    enabled: false
  externalDatabase:
    host: owl-postgresql
    port: 5432
    database: keycloak
    user: keycloak
    password: ""  # Set via values.lab-secrets.yaml
  ingress:
    enabled: true
    hostname: keycloak.devops.lab
    ingressClassName: nginx
    tls: true
    annotations:
      certmanager.step.sm/cluster-issuer: step-cluster-issuer
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: "1"
      memory: 1Gi
  realmImport:
    enabled: true

# -----------------------------------------------------------------------------
# Zammad — enabled for TicketOwl backend
# -----------------------------------------------------------------------------
zammad:
  enabled: true
  ingress:
    enabled: true
    hosts:
      - host: zammad.devops.lab
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: zammad-tls
        hosts:
          - zammad.devops.lab
    annotations:
      certmanager.step.sm/cluster-issuer: step-cluster-issuer

# -----------------------------------------------------------------------------
# MinIO — S3-compatible storage for BookOwl images
# -----------------------------------------------------------------------------
minio:
  enabled: true
  auth:
    rootUser: ""      # Set via values.lab-secrets.yaml
    rootPassword: ""  # Set via values.lab-secrets.yaml
  defaultBuckets: bookowl-images
  persistence:
    size: 5Gi
