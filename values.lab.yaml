# =============================================================================
# umbrella-owl — Lab environment overrides
# =============================================================================
# Layered on top of values.yaml:
#   helm install owl . -f values.lab.yaml -f values.lab-secrets.yaml
#
# This file contains structural configuration only (hostnames, replicas,
# resources, ingress rules, inter-service URLs). All secrets are left empty
# and must be provided via values.lab-secrets.yaml (generated by
# deploy/apply-secrets.sh).
# =============================================================================

# -----------------------------------------------------------------------------
# Global — shared OIDC config for all owl services
# -----------------------------------------------------------------------------
global:
  oidc:
    issuerUrl: "https://keycloak.devops.lab/realms/owls"

# -----------------------------------------------------------------------------
# GHCR registry credentials — pull private container images and Helm charts
# -----------------------------------------------------------------------------
registryCredentials:
  create: true
  username: ""    # Set via values.lab-secrets.yaml
  password: ""    # Set via values.lab-secrets.yaml

# -----------------------------------------------------------------------------
# NightOwl
# -----------------------------------------------------------------------------
nightowl:
  seed:
    enabled: true

  replicaCount:
    api: 1
    worker: 1

  image:
    tag: main
    pullPolicy: Always

  # Mount combined CA bundle so OIDC discovery trusts HTTPS Keycloak
  extraVolumes:
    - name: ca-bundle
      configMap:
        name: combined-ca-bundle
  extraVolumeMounts:
    - name: ca-bundle
      mountPath: /etc/ssl/certs/ca-certificates.crt
      subPath: ca-certificates.crt
      readOnly: true

  frontend:
    enabled: true
    image:
      tag: main
      pullPolicy: Always
    replicas: 1
    resources:
      requests:
        cpu: 25m
        memory: 32Mi
      limits:
        cpu: 100m
        memory: 64Mi

  api:
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 250m
        memory: 128Mi

  worker:
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 125m
        memory: 128Mi

  config:
    logLevel: debug
    corsAllowedOrigins: "https://nightowl.devops.lab"
    bookowlUrl: "https://bookowl.devops.lab"
    ticketowlUrl: "https://ticketowl.devops.lab"
    bookowlApiUrl: "http://owl-bookowl-api:8081/api/v1"

  secrets:
    databaseUrl: ""       # Set via values.lab-secrets.yaml
    redisUrl: ""            # Set via values.lab-secrets.yaml
    oidcClientId: "nightowl"
    oidcClientSecret: ""  # Set via values.lab-secrets.yaml
    oidcRedirectUrl: "https://nightowl.devops.lab/auth/oidc/callback"
    sessionSecret: ""     # Set via values.lab-secrets.yaml

  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/issuer: step-cluster-issuer
      cert-manager.io/issuer-kind: StepClusterIssuer
      cert-manager.io/issuer-group: certmanager.step.sm
    hosts:
      - host: nightowl.devops.lab
        paths:
          - path: /api
            pathType: Prefix
            service: api
          - path: /auth
            pathType: Prefix
            service: api
          - path: /status
            pathType: Prefix
            service: api
          - path: /healthz
            pathType: Prefix
            service: api
          - path: /metrics
            pathType: Prefix
            service: api
          - path: /
            pathType: Prefix
            service: frontend
    tls:
      - secretName: nightowl-tls
        hosts:
          - nightowl.devops.lab

  serviceMonitor:
    enabled: false

  podDisruptionBudget:
    enabled: false

# -----------------------------------------------------------------------------
# BookOwl
# -----------------------------------------------------------------------------
bookowl:
  seed:
    enabled: true

  publicUrl: "https://bookowl.devops.lab"

  nightowl:
    url: "https://nightowl.devops.lab"
  ticketowl:
    url: "https://ticketowl.devops.lab"

  image:
    tag: main
    pullPolicy: Always

  web:
    image:
      tag: main
      pullPolicy: Always
    replicas: 1
    resources:
      requests:
        cpu: 25m
        memory: 32Mi
      limits:
        cpu: 100m
        memory: 64Mi

  api:
    replicas: 1
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 250m
        memory: 128Mi

  collab:
    replicas: 1
    image:
      tag: main
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 250m
        memory: 128Mi
    wsUrl: "wss://collab.bookowl.devops.lab"
    ingress:
      enabled: true
      host: collab.bookowl.devops.lab

  # Mount combined CA bundle so OIDC discovery trusts HTTPS Keycloak
  extraVolumes:
    - name: ca-bundle
      configMap:
        name: combined-ca-bundle
  extraVolumeMounts:
    - name: ca-bundle
      mountPath: /etc/ssl/certs/ca-certificates.crt
      subPath: ca-certificates.crt
      readOnly: true

  secretKey: ""  # Set via values.lab-secrets.yaml

  database:
    url: ""  # Set via values.lab-secrets.yaml

  redis:
    url: ""      # Set via values.lab-secrets.yaml
    host: owl-redis-master
    port: "6379"
    password: ""  # Set via values.lab-secrets.yaml

  oidc:
    clientId: bookowl
    clientSecret: ""  # Set via values.lab-secrets.yaml
    redirectUrl: "https://bookowl.devops.lab/auth/oidc/callback"

  nightowl:
    apiUrl: "http://owl-nightowl:80"
    apiKey: ""  # Set via values.lab-secrets.yaml
    url: "https://nightowl.devops.lab"

  ticketowl:
    url: "https://ticketowl.devops.lab"

  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/issuer: step-cluster-issuer
      cert-manager.io/issuer-kind: StepClusterIssuer
      cert-manager.io/issuer-group: certmanager.step.sm
      nginx.ingress.kubernetes.io/proxy-body-size: "20m"
    hosts:
      - host: bookowl.devops.lab
        paths:
          - path: /api
            pathType: Prefix
            service: api
          - path: /auth
            pathType: Prefix
            service: api
          - path: /status
            pathType: Prefix
            service: api
          - path: /
            pathType: Prefix
            service: web
    tls:
      - secretName: bookowl-tls
        hosts:
          - bookowl.devops.lab

  metrics:
    enabled: false
    serviceMonitor:
      enabled: false

  pdb:
    enabled: false

# -----------------------------------------------------------------------------
# TicketOwl
# -----------------------------------------------------------------------------
ticketowl:
  seed:
    enabled: true

  image:
    tag: main
    pullPolicy: Always

  web:
    enabled: true
    image:
      tag: main
      pullPolicy: Always
    replicas: 1
    resources:
      requests:
        cpu: 25m
        memory: 32Mi
      limits:
        cpu: 100m
        memory: 64Mi

  api:
    replicaCount: 1
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 250m
        memory: 128Mi
    autoscaling:
      enabled: false

  worker:
    replicaCount: 1
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 125m
        memory: 128Mi

  # Mount step CA cert so OIDC discovery trusts HTTPS Keycloak
  extraVolumes:
    - name: ca-bundle
      configMap:
        name: combined-ca-bundle
  extraVolumeMounts:
    - name: ca-bundle
      mountPath: /etc/ssl/certs/ca-certificates.crt
      subPath: ca-certificates.crt
      readOnly: true

  config:
    logLevel: debug
    nightowlApiUrl: "http://owl-nightowl:80"
    bookowlApiUrl: "http://owl-bookowl-api:8081"
    nightowlUrl: "https://nightowl.devops.lab"
    bookowlUrl: "https://bookowl.devops.lab"
    zammadUrl: "http://owl-zammad:8080"

  secrets:
    dbUrl: ""             # Set via values.lab-secrets.yaml
    redisUrl: ""            # Set via values.lab-secrets.yaml
    oidcClientId: "ticketowl"
    oidcClientSecret: ""  # Set via values.lab-secrets.yaml
    oidcRedirectUrl: "https://ticketowl.devops.lab/auth/oidc/callback"
    encryptionKey: ""     # Set via values.lab-secrets.yaml
    nightowlApiKey: ""    # Set via values.lab-secrets.yaml
    bookowlApiKey: ""     # Set via values.lab-secrets.yaml
    zammadToken: ""       # Set via values.lab-secrets.yaml

  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/issuer: step-cluster-issuer
      cert-manager.io/issuer-kind: StepClusterIssuer
      cert-manager.io/issuer-group: certmanager.step.sm
    hosts:
      - host: ticketowl.devops.lab
        paths:
          - path: /api
            pathType: Prefix
            service: api
          - path: /auth
            pathType: Prefix
            service: api
          - path: /status
            pathType: Prefix
            service: api
          - path: /
            pathType: Prefix
            service: web
    tls:
      - secretName: ticketowl-tls
        hosts:
          - ticketowl.devops.lab

  podDisruptionBudget:
    enabled: false

# -----------------------------------------------------------------------------
# PostgreSQL — in-cluster for lab
# -----------------------------------------------------------------------------
postgresql:
  enabled: true
  image:
    tag: latest
  auth:
    postgresPassword: ""  # Set via values.lab-secrets.yaml
    database: nightowl
  primary:
    persistence:
      size: 10Gi
      # Uses default StorageClass (Longhorn)
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi
    # NOTE: initdb.scripts is in values.lab-secrets.yaml because it contains
    # database user passwords that must match the service database URLs.

# -----------------------------------------------------------------------------
# Redis — in-cluster, standalone, no auth
# -----------------------------------------------------------------------------
redis:
  enabled: true
  image:
    tag: latest
  architecture: standalone
  auth:
    enabled: true
    password: ""  # Set via values.lab-secrets.yaml
  master:
    persistence:
      size: 2Gi
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 125m
        memory: 128Mi

# -----------------------------------------------------------------------------
# Keycloak — enabled for OIDC
# -----------------------------------------------------------------------------
keycloak:
  enabled: true
  image:
    repository: bitnamilegacy/keycloak
    tag: 26.3.3-debian-12-r0
  auth:
    adminUser: admin
    adminPassword: ""  # Set via values.lab-secrets.yaml
  production: false
  proxyHeaders: xforwarded
  extraEnvVars:
    - name: KC_HOSTNAME
      value: "https://keycloak.devops.lab"
  postgresql:
    enabled: false
  externalDatabase:
    host: owl-postgresql
    port: 5432
    database: keycloak
    user: keycloak
    password: ""  # Set via values.lab-secrets.yaml
  ingress:
    enabled: true
    hostname: keycloak.devops.lab
    ingressClassName: nginx
    tls: true
    annotations:
      cert-manager.io/issuer: step-cluster-issuer
      cert-manager.io/issuer-kind: StepClusterIssuer
      cert-manager.io/issuer-group: certmanager.step.sm
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: "1"
      memory: 1Gi
  realmImport:
    enabled: true

# -----------------------------------------------------------------------------
# Zammad — enabled for TicketOwl backend
# -----------------------------------------------------------------------------
zammad:
  enabled: true
  # Auto-create admin user on fresh install (no-op if users already exist)
  autoWizard:
    enabled: true
    config: |
      {
        "Users": [{
          "login": "admin@wisbric.local",
          "firstname": "Admin",
          "lastname": "Wisbric",
          "email": "admin@wisbric.local",
          "password": "OwlAdmin2026!"
        }],
        "Settings": [
          { "name": "product_name", "value": "Zammad (Lab)" },
          { "name": "timezone_default", "value": "Pacific/Auckland" }
        ],
        "Organizations": [
          { "name": "Acme Corp" },
          { "name": "Wisbric" }
        ]
      }
  # Disable Zammad's internal PostgreSQL and Redis — use shared instances
  zammadConfig:
    postgresql:
      enabled: false
      host: owl-postgresql
      port: 5432
      user: zammad
      pass: ""    # Set via values.lab-secrets.yaml
      db: zammad
    redis:
      enabled: false
      host: owl-redis-master
      port: 6379
      pass: ""  # Set via values.lab-secrets.yaml
  elasticsearch:
    image:
      repository: bitnamilegacy/elasticsearch
      tag: 8.12.0-debian-11-r1
    sysctlImage:
      registry: docker.io
      repository: bitnamilegacy/os-shell
      tag: 11-debian-11-r94
  memcached:
    image:
      repository: bitnamilegacy/memcached
      tag: 1.6.23-debian-11-r0
  ingress:
    enabled: true
    hosts:
      - host: zammad.devops.lab
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: zammad-tls
        hosts:
          - zammad.devops.lab
    annotations:
      cert-manager.io/issuer: step-cluster-issuer
      cert-manager.io/issuer-kind: StepClusterIssuer
      cert-manager.io/issuer-group: certmanager.step.sm

# -----------------------------------------------------------------------------
# MinIO — S3-compatible storage for BookOwl images
# -----------------------------------------------------------------------------
minio:
  enabled: true
  image:
    repository: bitnamilegacy/minio
    tag: 2024.11.7-debian-12-r0
  auth:
    rootUser: ""      # Set via values.lab-secrets.yaml
    rootPassword: ""  # Set via values.lab-secrets.yaml
  defaultBuckets: bookowl-images
  persistence:
    size: 5Gi
