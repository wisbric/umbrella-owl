name: Helm Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.17.0

      # ---------------------------------------------------------------
      # Create stub subcharts so file:// deps resolve without
      # cross-repo checkout (each service has its own CI for linting)
      # ---------------------------------------------------------------
      - name: Create stub subcharts
        run: |
          for spec in \
            "nightowl:nightowl/deploy/helm/nightowl" \
            "bookowl:bookowl/deploy/helm/bookowl" \
            "ticketowl:ticketowl/charts/ticketowl"; do
            name="${spec%%:*}"
            dir="../${spec#*:}"
            mkdir -p "$dir/templates"
            cat > "$dir/Chart.yaml" << CHARTEOF
          apiVersion: v2
          name: $name
          version: 0.1.0
          type: application
          CHARTEOF
            echo "{}" > "$dir/values.yaml"
          done

      # ---------------------------------------------------------------
      # Lint umbrella chart
      # ---------------------------------------------------------------
      - name: Build umbrella dependencies
        run: helm dep build .

      - name: Lint umbrella
        run: helm lint .

      # ---------------------------------------------------------------
      # Dry-run template rendering with lab values
      # Uses a stub secrets file so gitignored values.lab-secrets.yaml
      # is not required.
      # ---------------------------------------------------------------
      - name: Create stub secrets for dry-run
        run: |
          cat > /tmp/values-stub-secrets.yaml << 'STUBEOF'
          nightowl:
            secrets:
              databaseUrl: "postgres://stub:stub@localhost/nightowl"
              sessionSecret: "stub-session-secret"
              oidcClientSecret: "stub-oidc-secret"
          bookowl:
            secretKey: "stub-secret-key"
            database:
              url: "postgres://stub:stub@localhost/bookowl"
            nightowl:
              apiKey: "stub-api-key"
          ticketowl:
            secrets:
              dbUrl: "postgres://stub:stub@localhost/ticketowl"
              encryptionKey: "stub-encryption-key"
              nightowlApiKey: "stub-api-key"
              bookowlApiKey: "stub-api-key"
          postgresql:
            auth:
              postgresPassword: "stub"
          keycloak:
            auth:
              adminPassword: "stub"
            externalDatabase:
              password: "stub"
          minio:
            auth:
              rootUser: "stub"
              rootPassword: "stub"
          STUBEOF

      - name: Dry-run helm template
        run: helm template owl . -f values.lab.yaml -f /tmp/values-stub-secrets.yaml --dry-run > /dev/null
