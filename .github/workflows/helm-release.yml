name: Helm Release

on:
  push:
    tags:
      - "v*"

permissions:
  packages: write
  contents: read

env:
  OCI_REGISTRY: oci://ghcr.io/wisbric/charts

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      # ---------------------------------------------------------------
      # Checkout all repos so file:// subchart refs resolve
      # ---------------------------------------------------------------
      - name: Checkout umbrella-owl
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: umbrella-owl

      - name: Checkout nightowl
        uses: actions/checkout@v4
        with:
          repository: wisbric/nightowl
          path: nightowl

      - name: Checkout bookowl
        uses: actions/checkout@v4
        with:
          repository: wisbric/bookowl
          path: bookowl

      - name: Checkout ticketowl
        uses: actions/checkout@v4
        with:
          repository: wisbric/ticketowl
          path: ticketowl

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.17.0

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      # ---------------------------------------------------------------
      # Publish subchart: nightowl
      # ---------------------------------------------------------------
      - name: Lint nightowl
        run: helm lint nightowl/deploy/helm/nightowl

      - name: Set nightowl chart version
        run: |
          sed -i "s/^version:.*/version: \"${{ steps.version.outputs.VERSION }}\"/" \
            nightowl/deploy/helm/nightowl/Chart.yaml

      - name: Package nightowl
        run: helm package nightowl/deploy/helm/nightowl --destination /tmp/charts

      - name: Push nightowl
        run: helm push /tmp/charts/nightowl-${{ steps.version.outputs.VERSION }}.tgz ${{ env.OCI_REGISTRY }}

      # ---------------------------------------------------------------
      # Publish subchart: bookowl
      # ---------------------------------------------------------------
      - name: Lint bookowl
        run: helm lint bookowl/deploy/helm/bookowl

      - name: Set bookowl chart version
        run: |
          sed -i "s/^version:.*/version: \"${{ steps.version.outputs.VERSION }}\"/" \
            bookowl/deploy/helm/bookowl/Chart.yaml

      - name: Package bookowl
        run: helm package bookowl/deploy/helm/bookowl --destination /tmp/charts

      - name: Push bookowl
        run: helm push /tmp/charts/bookowl-${{ steps.version.outputs.VERSION }}.tgz ${{ env.OCI_REGISTRY }}

      # ---------------------------------------------------------------
      # Publish subchart: ticketowl
      # ---------------------------------------------------------------
      - name: Lint ticketowl
        run: helm lint ticketowl/charts/ticketowl

      - name: Set ticketowl chart version
        run: |
          sed -i "s/^version:.*/version: \"${{ steps.version.outputs.VERSION }}\"/" \
            ticketowl/charts/ticketowl/Chart.yaml

      - name: Package ticketowl
        run: helm package ticketowl/charts/ticketowl --destination /tmp/charts

      - name: Push ticketowl
        run: helm push /tmp/charts/ticketowl-${{ steps.version.outputs.VERSION }}.tgz ${{ env.OCI_REGISTRY }}

      # ---------------------------------------------------------------
      # Publish umbrella chart (last â€” depends on subcharts above)
      # ---------------------------------------------------------------
      - name: Rewrite umbrella Chart.yaml for OCI registry
        working-directory: umbrella-owl
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          sed -i \
            -e "s|^version:.*|version: \"$VERSION\"|" \
            -e "s|repository: \"file://../nightowl/deploy/helm/nightowl\"|repository: ${{ env.OCI_REGISTRY }}|" \
            -e "s|repository: \"file://../bookowl/deploy/helm/bookowl\"|repository: ${{ env.OCI_REGISTRY }}|" \
            -e "s|repository: \"file://../ticketowl/charts/ticketowl\"|repository: ${{ env.OCI_REGISTRY }}|" \
            Chart.yaml
          # Pin subchart versions to this release
          sed -i "/name: nightowl/,/repository:/{s/version: .*/version: \"$VERSION\"/}" Chart.yaml
          sed -i "/name: bookowl/,/repository:/{s/version: .*/version: \"$VERSION\"/}" Chart.yaml
          sed -i "/name: ticketowl/,/repository:/{s/version: .*/version: \"$VERSION\"/}" Chart.yaml

      - name: Build umbrella dependencies
        working-directory: umbrella-owl
        run: helm dep build .

      - name: Lint umbrella
        working-directory: umbrella-owl
        run: helm lint .

      - name: Package umbrella
        working-directory: umbrella-owl
        run: helm package . --destination /tmp/charts

      - name: Push umbrella
        run: helm push /tmp/charts/umbrella-owl-${{ steps.version.outputs.VERSION }}.tgz ${{ env.OCI_REGISTRY }}

  summary:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Print published charts
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "### Published Helm charts" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Chart | OCI URL |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|---------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| nightowl | \`oci://ghcr.io/wisbric/charts/nightowl:${VERSION}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| bookowl | \`oci://ghcr.io/wisbric/charts/bookowl:${VERSION}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| ticketowl | \`oci://ghcr.io/wisbric/charts/ticketowl:${VERSION}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| umbrella-owl | \`oci://ghcr.io/wisbric/charts/umbrella-owl:${VERSION}\` |" >> "$GITHUB_STEP_SUMMARY"
