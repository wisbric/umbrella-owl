name: Helm Release

on:
  push:
    tags:
      - "v*"

permissions:
  packages: write
  contents: read

env:
  OCI_REGISTRY: oci://ghcr.io/wisbric/charts

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.17.0

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      # ---------------------------------------------------------------
      # Rewrite Chart.yaml: file:// refs â†’ OCI registry, pin versions
      # ---------------------------------------------------------------
      - name: Rewrite umbrella Chart.yaml for OCI registry
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          sed -i \
            -e "s|^version:.*|version: \"$VERSION\"|" \
            -e "s|repository: \"file://../nightowl/deploy/helm/nightowl\"|repository: ${{ env.OCI_REGISTRY }}|" \
            -e "s|repository: \"file://../bookowl/deploy/helm/bookowl\"|repository: ${{ env.OCI_REGISTRY }}|" \
            -e "s|repository: \"file://../ticketowl/charts/ticketowl\"|repository: ${{ env.OCI_REGISTRY }}|" \
            Chart.yaml
          # Pin subchart versions to this release
          sed -i "/name: nightowl/,/repository:/{s/version: .*/version: \"$VERSION\"/}" Chart.yaml
          sed -i "/name: bookowl/,/repository:/{s/version: .*/version: \"$VERSION\"/}" Chart.yaml
          sed -i "/name: ticketowl/,/repository:/{s/version: .*/version: \"$VERSION\"/}" Chart.yaml

      - name: Build umbrella dependencies
        run: helm dep build .

      - name: Lint umbrella
        run: helm lint .

      - name: Package umbrella
        run: helm package . --destination /tmp/charts

      - name: Push umbrella
        run: helm push /tmp/charts/umbrella-owl-${{ steps.version.outputs.VERSION }}.tgz ${{ env.OCI_REGISTRY }}

  summary:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Print published charts
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "### Published Helm charts" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Chart | OCI URL |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|---------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| umbrella-owl | \`oci://ghcr.io/wisbric/charts/umbrella-owl:${VERSION}\` |" >> "$GITHUB_STEP_SUMMARY"
